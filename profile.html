<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile | Civic Report</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; color: #333;
    }
    .container { max-width: 820px; margin: 0 auto; padding: 20px; }
    .header {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px; padding: 20px; margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px);
    }
    .header h1 { color: #2c3e50; margin-bottom: 10px; font-size: 2.5rem; }
    .back-btn {
      background: linear-gradient(135deg, #95a5a6, #7f8c8d);
      color: white; border: none; padding: 10px 20px;
      border-radius: 25px; cursor: pointer; font-weight: bold;
      text-decoration: none; display: inline-block; margin-bottom: 20px;
      transition: transform 0.3s ease;
    }
    .back-btn:hover { transform: translateY(-2px); }
    .profile-card {
      background: rgba(255,255,255,0.95); border-radius: 15px;
      padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      margin-bottom: 30px; backdrop-filter: blur(10px);
    }
    .profile-header {
      display: flex; align-items: center; gap: 30px; margin-bottom: 30px;
      padding-bottom: 20px; border-bottom: 2px solid #ecf0f1;
    }
    .profile-avatar {
      width: 120px; height: 120px;
      background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 3rem; font-weight: bold;
      box-shadow: 0 8px 32px rgba(102,126,234,0.3);
    }
    .profile-info h2 { color: #2c3e50; margin-bottom: 10px; font-size: 2rem; }
    .profile-info p { color: #7f8c8d; margin-bottom: 5px; font-size: 1.1rem; }
    .profile-stats {
      display: grid; grid-template-columns: repeat(auto-fit,minmax(195px,1fr));
      gap: 20px; margin-bottom: 30px;
    }
    .stat-item {
      background: #f8f9fa; border-radius: 10px; padding: 20px; text-align:center;
      border-left: 4px solid #667eea;
    }
    .stat-number { font-size: 2rem; font-weight: bold; color: #2c3e50; margin-bottom:5px; }
    .stat-label { color: #7f8c8d; font-size: 0.9rem; }
    .profile-actions {
      display: flex; gap: 14px; flex-wrap: wrap; margin-bottom: 16px;
    }
    .btn {
      background: linear-gradient(135deg,#667eea,#764ba2); color:white;
      border:none; padding: 12px 24px; border-radius:25px; cursor:pointer;
      font-weight:bold; text-decoration:none; display:inline-block;
      transition:transform .3s ease;
    }
    .btn-secondary { background: linear-gradient(135deg,#95a5a6,#7f8c8d);}
    .btn-danger { background: linear-gradient(135deg,#e74c3c,#c0392b);}
    .btn:hover { transform: translateY(-2px); }
    .form-group { margin-bottom: 20px;}
    .form-group label { display:block;margin-bottom:5px;color:#2c3e50;font-weight:bold;}
    .form-group input {
      width: 100%; padding: 12px; border: 2px solid #ecf0f1;
      border-radius: 8px; font-size: 1rem; transition: border-color .3s ease;
    }
    .form-group input:focus { outline:none; border-color:#667eea; }
    .edit-form { display: none; background: #f8f9fa; border-radius:10px; padding:20px; margin-top:20px;}
    .edit-form.show { display: block; }
    .raise-issue-form {
      background: #f6f6fb; border: 1.5px solid #764ba244; border-radius: 14px;
      padding: 18px 22px; margin: 22px 0 18px 0;
    }
    .raise-issue-form h3 { color:#544fa2; margin-bottom:10px;}
    .raise-issue-form input, .raise-issue-form select {
      border:1px solid #bbb; border-radius:7px; padding:9px 8px; font-size:1rem;
      margin-right:7px; outline: none; margin-bottom:7px;
    }
    .recent-issues-card {
      background: #fff; border-radius: 16px; box-shadow: 0 2px 16px #753be322;
      max-width: 94vw; margin: 30px auto 0 auto; padding: 22px 24px;
    }
    .issues-list { margin-top:10px;}
    .issue-item {
      background:#f3f4fa; border-radius:8px; margin-bottom:10px;
      padding:12px 16px; border-left: 7px solid #397af2; font-size:1.02em;
    }
    .issue-status { font-weight:700;font-size:0.95em;padding:3px 12px;border-radius:7px;margin-left:8px;}
    .status-open{background:#ffecec;color:#e23939;}
    .status-pending{background:#fff3d2;color:#ffb500;}
    .status-resolved{background:#e7ffe7;color:#35b728;}
    @media (max-width:800px){
      .profile-header { flex-direction:column;text-align:center; }
      .profile-stats { grid-template-columns:1fr;}
      .profile-actions,.raise-issue-form { flex-direction:column;}
      .recent-issues-card { margin:24px 4vw;}
    }
  </style>
</head>
<body>
<script>
  // Check authentication status
  if(localStorage.getItem("loggedIn") !== "true"){
    localStorage.setItem("redirectAfterLogin", "profile.html");
    window.location.href = "login.html";
  }
</script>

<div class="container">
  <div class="header">
    <a href="index.html" class="back-btn">
      <i class="fas fa-arrow-left"></i> Back to Home
    </a>
    <h1><i class="fas fa-user-circle"></i> My Profile</h1>
  </div>

  <div class="profile-card">
    <div class="profile-header">
      <div class="profile-avatar" id="profileAvatar">U</div>
      <div class="profile-info">
        <h2 id="profileName">User Name</h2>
        <p id="profileEmail">user@example.com</p>
        <p id="profilePhone">+91 0000000000</p>
        <p>Member since: <span id="memberSince">2024</span></p>
      </div>
    </div>
    <div class="profile-stats">
      <div class="stat-item">
        <div class="stat-number" id="totalIssues">0</div>
        <div class="stat-label">Total Issues</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="resolvedIssues">0</div>
        <div class="stat-label">Resolved</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="pendingIssues">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="communityRank">#1</div>
        <div class="stat-label">Community Rank</div>
      </div>
    </div>
    <div class="profile-actions">
      <button class="btn" onclick="toggleEditForm()"><i class="fas fa-edit"></i> Edit Profile</button>
      <a href="dashboard.html" class="btn btn-secondary"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
      <a href="report.html" class="btn"><i class="fas fa-plus"></i> Report Issue</a>
      <button class="btn btn-danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
    <div class="edit-form" id="editForm">
      <h3>Edit Profile Information</h3>
      <form id="profileForm">
        <div class="form-group">
          <label for="editName">Full Name:</label>
          <input type="text" id="editName" required>
        </div>
        <div class="form-group">
          <label for="editPhone">Phone Number:</label>
          <input type="text" id="editPhone" required>
        </div>
        <div class="form-group">
          <label for="editEmail">Email:</label>
          <input type="email" id="editEmail" required>
        </div>
        <div class="form-group">
          <button type="submit" class="btn">Save Changes</button>
          <button type="button" class="btn btn-secondary" onclick="toggleEditForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Raise New Issue Form -->
  <div class="raise-issue-form">
    <h3>Raise New Issue</h3>
    <form id="raiseIssueForm">
      <input type="text" id="issueTitle" placeholder="Issue title (required)" required>
      <select id="issueStatus">
        <option value="open">Open</option>
        <option value="pending">Pending</option>
        <option value="resolved">Resolved</option>
      </select>
      <button type="submit" class="btn">Submit</button>
    </form>
  </div>
  
  <!-- Recent Issues Card: Place after profile card -->
  <div class="recent-issues-card">
    <h3><i class="fa fa-list"></i> Recent Issues</h3>
    <div class="issues-list" id="userIssues"></div>
  </div>
</div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    loadUserData();
    loadUserStats();
    renderIssues();
  });

  function loadUserData() {
    const userName = localStorage.getItem("userName") || "User";
    const userEmail = localStorage.getItem("userEmail") || "user@example.com";
    document.getElementById("profileName").textContent = userName;
    document.getElementById("profileEmail").textContent = userEmail;
    document.getElementById("profileAvatar").textContent = userName.charAt(0).toUpperCase();

    const users = JSON.parse(localStorage.getItem('civicUsers') || '[]');
    const currentUser = users.find(u => u.email === userEmail);
    if (currentUser) {
      document.getElementById("profilePhone").textContent = currentUser.phone || "+91 0000000000";
      document.getElementById("editName").value = currentUser.name;
      document.getElementById("editPhone").value = currentUser.phone;
      document.getElementById("editEmail").value = currentUser.email;
    }
  }
   function loadUserStats() {
     const userEmail = localStorage.getItem("userEmail") || "user@example.com";
     const userIssues = JSON.parse(localStorage.getItem('userIssues') || '[]');
     
     // Filter issues for current user
     const userSpecificIssues = userIssues.filter(issue => issue.userEmail === userEmail);
     
     const totalIssues = userSpecificIssues.length;
     const resolvedIssues = userSpecificIssues.filter(issue => issue.status === 'resolved').length;
     const pendingIssues = userSpecificIssues.filter(issue => issue.status === 'pending' || issue.status === 'open').length;
     
     document.getElementById("totalIssues").textContent = totalIssues;
     document.getElementById("resolvedIssues").textContent = resolvedIssues;
     document.getElementById("pendingIssues").textContent = pendingIssues;
     
     // Calculate community rank based on total issues
     const rank = Math.max(1, Math.floor(Math.random() * 100) + 1);
     document.getElementById("communityRank").textContent = "#" + rank;
   }
  function toggleEditForm() {
    const editForm = document.getElementById("editForm");
    editForm.classList.toggle("show");
  }
  document.getElementById("profileForm").onsubmit = function(e) {
    e.preventDefault();
    const newName = document.getElementById("editName").value;
    const newPhone = document.getElementById("editPhone").value;
    const newEmail = document.getElementById("editEmail").value;
    localStorage.setItem("userName", newName);
    localStorage.setItem("userEmail", newEmail);
    const users = JSON.parse(localStorage.getItem('civicUsers') || '[]');
    const userIndex = users.findIndex(u => u.email === localStorage.getItem("userEmail"));
    if (userIndex !== -1) {
      users[userIndex].name = newName;
      users[userIndex].phone = newPhone;
      users[userIndex].email = newEmail;
      localStorage.setItem('civicUsers', JSON.stringify(users));
    }
    loadUserData();
    toggleEditForm();
    alert("Profile updated successfully!");
  };
  function logout() {
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("userName");
    localStorage.removeItem("userEmail");
    window.location.href = "index.html";
  }
   function renderIssues() {
     const userEmail = localStorage.getItem("userEmail") || "user@example.com";
     const allIssues = JSON.parse(localStorage.getItem('userIssues') || '[]');
     
     // Filter issues for current user
     const userSpecificIssues = allIssues.filter(issue => issue.userEmail === userEmail);
     
     const list = document.getElementById('userIssues');
     if (!userSpecificIssues.length) {
       list.innerHTML = "<p style='color:#bbb;'>No issues reported yet.</p>";
       return;
     }
     list.innerHTML = '';
     userSpecificIssues.forEach(issue => {
       let statClass =
         issue.status === "open" ? "status-open"
         : issue.status === "resolved" ? "status-resolved"
         : "status-pending";
       list.innerHTML += `
         <div class="issue-item">
           <b>${issue.category || issue.title || 'Issue'}</b>
           <span class="issue-status ${statClass}">${capitalize(issue.status)}</span><br>
           <span style="color: #7f8c8d; font-size: 0.9rem;">${issue.area || issue.desc || 'No description'}</span><br>
           <span style="color: #bbb; font-size: 0.8rem;">${issue.dateDisplay || issue.submittedAt || ""}</span>
         </div>
       `;
     });
   }
  function capitalize(word) {
    return word.charAt(0).toUpperCase() + word.slice(1);
  }
  // Raise Issue function                          
  document.getElementById('raiseIssueForm').addEventListener('submit', function(e){
    e.preventDefault();
    const title = document.getElementById('issueTitle').value.trim();
    const status = document.getElementById('issueStatus').value;
    const userName = localStorage.getItem("userName") || "User";
    const userEmail = localStorage.getItem("userEmail") || "user@example.com";
    
    if(!title) return alert("Please enter an issue title.");
    
    const newIssue = {
      id: Date.now() + Math.random(),
      title: title,
      category: title,
      area: "General",
      desc: title,
      user: userName,
      userEmail: userEmail,
      status: status,
      date: new Date().toISOString(),
      dateDisplay: new Date().toLocaleDateString(),
      submittedAt: new Date().toLocaleString(),
      timestamp: Date.now()
    };
    
    // Save to user's personal issues
    let userIssues = JSON.parse(localStorage.getItem('userIssues') || '[]');
    userIssues.push(newIssue);
    localStorage.setItem('userIssues', JSON.stringify(userIssues));
    
    // Save to global issues
    let allIssues = JSON.parse(localStorage.getItem('allIssues') || '[]');
    allIssues.push(newIssue);
    localStorage.setItem('allIssues', JSON.stringify(allIssues));
    
    // Update user stats
    let userStats = JSON.parse(localStorage.getItem('userStats') || '{}');
    if (!userStats[userEmail]) {
      userStats[userEmail] = { totalIssues: 0, resolvedIssues: 0, pendingIssues: 0 };
    }
    userStats[userEmail].totalIssues += 1;
    if (status === 'resolved') {
      userStats[userEmail].resolvedIssues += 1;
    } else {
      userStats[userEmail].pendingIssues += 1;
    }
    localStorage.setItem('userStats', JSON.stringify(userStats));
    
    document.getElementById('issueTitle').value = "";
    loadUserStats();
    renderIssues();
    alert("New issue submitted successfully!");
  });
  </script>
</body>
</html>
